/* Name: voltageOpenTest.c
 * Author: John Cook
 */

#include <avr/io.h>
#include <util/delay.h>
#include <stdint.h>

static int PASS = 1;
static int FAIL = 0;

void long_delay_ms(uint16_t ms) {
    for (ms /= 10;ms>0;ms--) {
        _delay_ms(10);
    }
}

// initialize all used registers to 0
void initTiny() {
    DDRB   &= 0;
    ADCSRA &= 0;
    ADCSRB &= 0;
    ADMUX  &= 0;
    PLLCSR &= 0;
    TCCR1  &= 0;
    OCR1B  &= 0;
    OCR1C  &= 0;
    GTCCR  &= 0;
}

// initialize registers involved in servo operation to 0
void initServo() {
    PLLCSR &= 0;
    TCCR1  &= 0;
    OCR1B  &= 0;
    OCR1C  &= 0;
    GTCCR  &= 0;
}

// initialize onboard ADC
void initADC() {
    DDRB   |=  (1<<PB5);     ///PB5/digital 13 is an output
    ADCSRA |=  ((1<<ADPS2)|(1<<ADPS1)|(1<<ADPS0));    //Prescaler at 128 so we have an 125Khz clock source
    ADMUX  |=  (1<<REFS0);
    ADMUX  &= ~(1<<REFS1);   //Avcc(+5v) as voltage reference
    ADCSRB &= ~((1<<ADTS2)|(1<<ADTS1)|(1<<ADTS0));    //ADC in free-running mode
    ADCSRA |=  (1<<ADATE);   //Signal source, in this case is the free-running
    ADCSRA |=  (1<<ADEN);    //Power up the ADC
    ADCSRA |=  (1<<ADSC);    //Start converting
}

// get voltage reading
int checkVoltage() {
    // input on PB0
    int adc_value = ADCW; // read the ADC value
    if(adc_value > 0){
        return PASS;
    }
    else {
        // turn on LED
        DDRB |= 1 << PB0;
        PORTB &= ~(1<<PB0);
        PORTB |= (1 << PB0);

        return FAIL;
    }
}

// activates parachute servo via PWM on PB4
void deployParachute() {
    PLLCSR |= (1 << PLLE) | (1 << PCKE);
    
    // Set prescaler to PCK/2048
    // (Setting CS (clock select) to 3)
    TCCR1 |= (1 << CS10) | (1 << CS11) | (0 << CS12) | (0 << CS13);
    
    // Output Compare Register
    OCR1B = 128;
    OCR1C = 255;
    
    // Enable OCRB output on PB4, configure compare mode and enable PWM B
    DDRB  |= (1 << PB4);
    GTCCR |= (1 << COM1B0) | (1 << COM1B1);
    GTCCR |= (1 << PWM1B);
    
    TCCR1 |= (1 << COM1A0);
    
    //while (1) {} // run infinitely
}

int main(void) {
    //initTiny();
    //initServo();
    //initADC();
    
    // runs continuously
    for(;;){
       // initServo();
        if (checkVoltage() == FAIL) {
            deployParachute();
        }
    }
    // never reached
    return 0;
}