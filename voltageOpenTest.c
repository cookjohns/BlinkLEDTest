/* Name: voltageOpenTest.c
 * Author: John Cook
 */

#include <avr/io.h>
#include <util/delay.h>
#include <stdint.h>

#define F_CPU 9600000

static int PASS = 1;
static int FAIL = 0;

void long_delay_ms(uint16_t ms) {
    for (ms /= 10;ms>0;ms--) {
        _delay_ms(10);
    }
}

// NOT CURRENTLY USED
// initialize all used registers to 0
void initTiny() {
    DDRB   &= 0;
    ADCSRA &= 0;
    ADCSRB &= 0;
    ADMUX  &= 0;
    PLLCSR &= 0;
    TCCR1  &= 0;
    OCR1B  &= 0;
    OCR1C  &= 0;
    GTCCR  &= 0;
}

// NOT CURRENTLY USED
// initialize registers involved in servo operation to 0
void initServo() {
    PLLCSR &= 0;
    TCCR1  &= 0;
    OCR1B  &= 0;
    OCR1C  &= 0;
    GTCCR  &= 0;
}

// initialize onboard ADC
void initADC() {
    // Set the ADC input to PB2/ADC1
    ADMUX |= (1 << MUX0);
    ADMUX |= (1 << ADLAR);
    // Set the prescaler to clock/128 & enable ADC
    ADCSRA |= (1 << ADPS1) | (1 << ADPS0) | (1 << ADEN);
}

// get voltage reading, input on PB2
int checkVoltage() {
    // Start the conversion
    ADCSRA |= (1 << ADSC);
    // Wait for it to finish
    while (ADCSRA & (1 << ADSC));
    
    if(ADCW > 0){ // greater than half
        // do something
        return PASS;
    }
    else {
        // do not something
        return FAIL;
    }
}

// activates parachute servo via PWM on PB4
void deployParachute() {
    // turn on LED
    DDRB |= 1 << PB1;
    PORTB &= ~(1<<PB1);
    PORTB |= (1 << PB1);
    
//    PLLCSR |= (1 << PLLE) | (1 << PCKE);
//    
//    // Set prescaler to PCK/2048
//    // (Setting CS (clock select) to 3)
//    TCCR1 |= (1 << CS10) | (1 << CS11) | (0 << CS12) | (0 << CS13);
//    
//    // Output Compare Register
//    OCR1B = 128;
//    OCR1C = 255;
//    
//    // Enable OCRB output on PB4, configure compare mode and enable PWM B
//    DDRB  |= (1 << PB4);
//    GTCCR |= (1 << COM1B0) | (1 << COM1B1);
//    GTCCR |= (1 << PWM1B);
//    
//    TCCR1 |= (1 << COM1A0);
//    
//    while (1) {} // run infinitely
}

int main(void) {
    initADC();
    
    // runs continuously
    for(;;){
       // initServo();
        if (checkVoltage() == FAIL) {
            deployParachute();
        }
    }
    // never reached
    return 0;
}